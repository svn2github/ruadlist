#!/bin/bash
# Как это работает:
#  * Первый SED:
#    1. Заменить все строки, начинающиеся с буквы и содержащие ##, подстрокой от начала строки и до ## (оставляет адреса от правил скрытия).
#    2. Заменить все строки, начинающиеся с || или protocol://, текстом после этих символов, но до символа /, $, ^ или * (оставляет адреса от правил блокировки доменов).
#  * Второй SED
#    1. Удаляем все строки начинающиеся не с текста, цифр или знака подчёркивания (знак подчёркивания не входит во множество \W).
#    2. Удаляем все строки начинающиеся со знака подчёркивания (дочищаем после п.1).
#    3. Удаляем все строки оканчивающиеся на точку (убиреам строки с не полными адресами).
#  * Третий SED:
#    1. Выполнять зацикленную обработку ввода до тех пор, пока не будет больше изменений.
#    2. Заменить двойной переход на новую строку на одинарный (удаляем пустые строки).
#    3. Заменить запятую на новую строку (разбивает списки доменов в списках правил скрытия).
#    4. Заменяем удаляем тильды оставшиеся от исключений в правилах скрытия.
#  * Сортируем получившийс список не смотря на регистр и удаляя дубликаты.
#  * Результат сохраняем в файл.
sed -r 's/^(\w[^#]*)##.*$/\1/g;s#^(\|{2}|\w*:?/{2})(\w[^/$^*]*).*$#\2#g' advblock.txt | sed -r 's#^\W.*$##g;s#^_.*$##g;s#^.*\.$##g' | sed ':a;N;$!ba;s/\n\n/\n/g;s/,/\n/g;s/~//g' | sort -fu > pinglist.txt

